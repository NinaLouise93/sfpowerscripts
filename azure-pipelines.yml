name: Milestone10-$(Rev:.r)

resources:
  repositories:
  - repository: forcedi # The name used to reference this repository in the checkout step
    type: github
    endpoint: azlamsalamgit
    name: azlamsalam/force-di


trigger:
 - develop
 - master

pr:
  branches:
    include:
    - develop
    - master

variables:
- group: Tokens


stages:
- stage: Review
  condition: and('true', eq(variables['build.Reason'], 'PullRequest'))
  jobs:
  - template: templates/buildplugins.yml  #Build Template
    parameters:
      name: 'DeployToReview'
      commitToGit: false
      stageToDeploy: 'review'
      version: 'auto'
      environmentToDeploy: 'review'
      toBuild: true
          
       
- stage: Develop
  condition: and('true', eq(variables['build.sourceBranch'], 'refs/heads/develop'))
  
  jobs:
   - template: templates/buildplugins.yml   #Build Template
     parameters:
      name: 'DeployToDevelop'
      commitToGit: true
      branchToDeploy: 'develop'
      stageToDeploy: 'dev'
      version: 'dev'
      environmentToDeploy: 'development'
      toBuild: true
      

   - job: WaitPluginToInstallonDevelopment
     displayName: 'Wait for  Plugin To Install on Development'
     dependsOn: DeployToDevelop
     pool: server
     steps:
      - task: Delay@1
        inputs:
         delayForMinutes: '2' 

   - template: templates/prtest.yml   
     parameters:
      name: 'TestPrOnLinux'
      image: 'ubuntu-latest'
      dependOnJob: 'WaitPluginToInstallonDevelopment'
      repositoryToCheckout: 'forcedi'
      directory: 'force-di'

  
   - template: templates/prtest.yml   
     parameters:
      name: 'TestPrOnWindows'
      image: 'vs2017-win2016'
      dependOnJob: 'WaitPluginToInstallonDevelopment'

- stage: Beta
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/develop'))
  dependsOn: Develop
  
  jobs:
   - template: templates/buildplugins.yml   #Build Template
     parameters:
      name: 'DeployToBeta'
      commitToGit: false
      branchToDeploy: 'develop'
      stageToDeploy: 'beta'
      version: 'beta'
      environmentToDeploy: 'beta'
      toBuild: true


- stage: Production
  dependsOn: Beta
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/develop'))
  
  jobs:
   - template: templates/buildplugins.yml   #Build Template
     parameters:
      name: 'DeployToProd'
      commitToGit: true
      branchToDeploy: 'master'
      stageToDeploy: 'prod'
      version: 'beta'
      environmentToDeploy: 'beta'
      toBuild: true

  
  